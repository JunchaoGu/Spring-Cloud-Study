<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSE å­¦ä¹ æµ‹è¯•é¡µé¢</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        h2 {
            color: #666;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .stop-btn {
            background-color: #f44336;
        }
        .stop-btn:hover {
            background-color: #da190b;
        }
        input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            width: 300px;
        }
        .output {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-top: 10px;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        .status.connecting {
            background-color: #fff3cd;
            color: #856404;
        }
        .info {
            background-color: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 10px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>ğŸš€ SSE (Server-Sent Events) å­¦ä¹ æµ‹è¯•é¡µé¢</h1>

    <!-- è¯´æ˜ -->
    <div class="container">
        <div class="info">
            <strong>ğŸ“– ä»€ä¹ˆæ˜¯ SSEï¼Ÿ</strong><br>
            SSE æ˜¯ä¸€ç§æœåŠ¡å™¨å‘å®¢æˆ·ç«¯æ¨é€æ•°æ®çš„æŠ€æœ¯ã€‚å°±åƒè®¢é˜…äº†ä¸€ä¸ªé¢‘é“ï¼ŒæœåŠ¡å™¨ä¼šä¸»åŠ¨ç»™ä½ æ¨é€æ¶ˆæ¯ã€‚
            <br><br>
            <strong>ğŸ’¡ å¦‚ä½•ä½¿ç”¨ï¼Ÿ</strong><br>
            1. ç‚¹å‡»ä¸‹é¢çš„æŒ‰é’®å¼€å§‹æµ‹è¯•<br>
            2. è§‚å¯Ÿ"è¾“å‡ºåŒºåŸŸ"ä¸­æ¥æ”¶åˆ°çš„æ¶ˆæ¯<br>
            3. ç‚¹å‡»"åœæ­¢è¿æ¥"æŒ‰é’®å¯ä»¥æ–­å¼€è¿æ¥
        </div>
    </div>

    <!-- ç¤ºä¾‹1ï¼šæœ€ç®€å•çš„ SSE -->
    <div class="container">
        <h2>ç¤ºä¾‹1ï¼šæœ€ç®€å•çš„ SSE è¿æ¥</h2>
        <p>åŠŸèƒ½ï¼šå‘é€3æ¡ç®€å•çš„æ–‡æœ¬æ¶ˆæ¯</p>
        <button onclick="testSimple()">å¼€å§‹æµ‹è¯•</button>
        <button class="stop-btn" onclick="stopConnection('simple')">åœæ­¢è¿æ¥</button>
        <div id="status-simple" class="status disconnected">æœªè¿æ¥</div>
        <div id="output-simple" class="output">ç­‰å¾…å¼€å§‹...</div>
    </div>

    <!-- ç¤ºä¾‹2ï¼šæµå¼å‘é€ -->
    <div class="container">
        <h2>ç¤ºä¾‹2ï¼šæµå¼å‘é€æ¶ˆæ¯ï¼ˆæ‰“å­—æ•ˆæœï¼‰</h2>
        <p>åŠŸèƒ½ï¼šå°†æ–‡æœ¬é€å­—å‘é€ï¼Œå°±åƒæ‰“å­—ä¸€æ ·</p>
        <input type="text" id="stream-text" placeholder="è¾“å…¥è¦å‘é€çš„æ–‡æœ¬" value="ä½ å¥½ï¼Œè¿™æ˜¯æµå¼å‘é€æµ‹è¯•ï¼">
        <button onclick="testStream()">å¼€å§‹æµ‹è¯•</button>
        <button class="stop-btn" onclick="stopConnection('stream')">åœæ­¢è¿æ¥</button>
        <div id="status-stream" class="status disconnected">æœªè¿æ¥</div>
        <div id="output-stream" class="output">ç­‰å¾…å¼€å§‹...</div>
    </div>

    <!-- ç¤ºä¾‹3ï¼šå®šæ—¶å‘é€ -->
    <div class="container">
        <h2>ç¤ºä¾‹3ï¼šå®šæ—¶å‘é€æ¶ˆæ¯ï¼ˆå®æ—¶æ•°æ®æ›´æ–°ï¼‰</h2>
        <p>åŠŸèƒ½ï¼šæ¯éš”1ç§’å‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œæ¨¡æ‹Ÿå®æ—¶æ•°æ®æ›´æ–°</p>
        <input type="number" id="timer-count" placeholder="æ¶ˆæ¯æ•°é‡" value="10" min="1" max="50">
        <button onclick="testTimer()">å¼€å§‹æµ‹è¯•</button>
        <button class="stop-btn" onclick="stopConnection('timer')">åœæ­¢è¿æ¥</button>
        <div id="status-timer" class="status disconnected">æœªè¿æ¥</div>
        <div id="output-timer" class="output">ç­‰å¾…å¼€å§‹...</div>
    </div>

    <!-- ç¤ºä¾‹4ï¼šJSON æ•°æ® -->
    <div class="container">
        <h2>ç¤ºä¾‹4ï¼šå‘é€ JSON æ ¼å¼çš„æ•°æ®</h2>
        <p>åŠŸèƒ½ï¼šå‘é€ JSON æ ¼å¼çš„æ¶ˆæ¯ï¼ˆå®é™…é¡¹ç›®ä¸­å¸¸ç”¨ï¼‰</p>
        <button onclick="testJson()">å¼€å§‹æµ‹è¯•</button>
        <button class="stop-btn" onclick="stopConnection('json')">åœæ­¢è¿æ¥</button>
        <div id="status-json" class="status disconnected">æœªè¿æ¥</div>
        <div id="output-json" class="output">ç­‰å¾…å¼€å§‹...</div>
    </div>

    <!-- ç¤ºä¾‹5ï¼šæ¨¡æ‹ŸèŠå¤© -->
    <div class="container">
        <h2>ç¤ºä¾‹5ï¼šæ¨¡æ‹ŸèŠå¤©åœºæ™¯</h2>
        <p>åŠŸèƒ½ï¼šæ¨¡æ‹Ÿ AI å›ç­”é—®é¢˜çš„åœºæ™¯ï¼Œé€å­—è¿”å›ç­”æ¡ˆ</p>
        <input type="text" id="chat-question" placeholder="è¾“å…¥ä½ çš„é—®é¢˜" value="ä»€ä¹ˆæ˜¯Java">
        <button onclick="testChat()">å¼€å§‹æµ‹è¯•</button>
        <button class="stop-btn" onclick="stopConnection('chat')">åœæ­¢è¿æ¥</button>
        <div id="status-chat" class="status disconnected">æœªè¿æ¥</div>
        <div id="output-chat" class="output">ç­‰å¾…å¼€å§‹...</div>
    </div>

    <script>
        // å­˜å‚¨æ‰€æœ‰çš„ EventSource è¿æ¥
        const connections = {};

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(type, status, message) {
            const statusEl = document.getElementById(`status-${type}`);
            statusEl.className = `status ${status}`;
            statusEl.textContent = message;
        }

        // æ·»åŠ è¾“å‡ºå†…å®¹
        function addOutput(type, message) {
            const outputEl = document.getElementById(`output-${type}`);
            const time = new Date().toLocaleTimeString();
            outputEl.textContent += `[${time}] ${message}\n`;
            outputEl.scrollTop = outputEl.scrollHeight; // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
        }

        // åœæ­¢è¿æ¥
        function stopConnection(type) {
            if (connections[type]) {
                connections[type].close();
                delete connections[type];
                updateStatus(type, 'disconnected', 'å·²æ–­å¼€è¿æ¥');
                addOutput(type, 'âŒ è¿æ¥å·²å…³é—­');
            }
        }

        // ç¤ºä¾‹1ï¼šæœ€ç®€å•çš„ SSE
        function testSimple() {
            stopConnection('simple');
            updateStatus('simple', 'connecting', 'æ­£åœ¨è¿æ¥...');
            addOutput('simple', 'ğŸ”— å¼€å§‹å»ºç«‹è¿æ¥...');

            const eventSource = new EventSource('/api/learn/sse/simple');
            connections['simple'] = eventSource;

            eventSource.onopen = function() {
                updateStatus('simple', 'connected', 'âœ… å·²è¿æ¥');
                addOutput('simple', 'âœ… è¿æ¥æˆåŠŸï¼');
            };

            eventSource.addEventListener('greeting', function(e) {
                addOutput('simple', `ğŸ“¨ [greeting] ${e.data}`);
            });

            eventSource.addEventListener('message', function(e) {
                addOutput('simple', `ğŸ“¨ [message] ${e.data}`);
            });

            eventSource.onerror = function(e) {
                updateStatus('simple', 'disconnected', 'âŒ è¿æ¥é”™è¯¯');
                addOutput('simple', 'âŒ è¿æ¥å‡ºé”™æˆ–å·²å…³é—­');
                eventSource.close();
            };
        }

        // ç¤ºä¾‹2ï¼šæµå¼å‘é€
        function testStream() {
            stopConnection('stream');
            const text = document.getElementById('stream-text').value || 'Hello, SSE!';
            updateStatus('stream', 'connecting', 'æ­£åœ¨è¿æ¥...');
            addOutput('stream', 'ğŸ”— å¼€å§‹å»ºç«‹è¿æ¥...');

            const eventSource = new EventSource(`/api/learn/sse/stream?text=${encodeURIComponent(text)}`);
            connections['stream'] = eventSource;

            eventSource.onopen = function() {
                updateStatus('stream', 'connected', 'âœ… å·²è¿æ¥');
                addOutput('stream', 'âœ… è¿æ¥æˆåŠŸï¼å¼€å§‹æ¥æ”¶æ•°æ®...\n');
            };

            eventSource.addEventListener('chunk', function(e) {
                // è¿½åŠ å­—ç¬¦ï¼Œä¸æ¢è¡Œï¼ˆæ¨¡æ‹Ÿæ‰“å­—æ•ˆæœï¼‰
                const outputEl = document.getElementById('output-stream');
                outputEl.textContent += e.data;
                outputEl.scrollTop = outputEl.scrollHeight;
            });

            eventSource.addEventListener('end', function(e) {
                addOutput('stream', `\n\n${e.data}`);
            });

            eventSource.onerror = function(e) {
                updateStatus('stream', 'disconnected', 'âŒ è¿æ¥é”™è¯¯');
                addOutput('stream', '\n\nâŒ è¿æ¥å‡ºé”™æˆ–å·²å…³é—­');
                eventSource.close();
            };
        }

        // ç¤ºä¾‹3ï¼šå®šæ—¶å‘é€
        function testTimer() {
            stopConnection('timer');
            const count = document.getElementById('timer-count').value || 10;
            updateStatus('timer', 'connecting', 'æ­£åœ¨è¿æ¥...');
            addOutput('timer', 'ğŸ”— å¼€å§‹å»ºç«‹è¿æ¥...');

            const eventSource = new EventSource(`/api/learn/sse/timer?count=${count}`);
            connections['timer'] = eventSource;

            eventSource.onopen = function() {
                updateStatus('timer', 'connected', 'âœ… å·²è¿æ¥');
                addOutput('timer', 'âœ… è¿æ¥æˆåŠŸï¼å¼€å§‹æ¥æ”¶å®æ—¶æ•°æ®...\n');
            };

            eventSource.addEventListener('update', function(e) {
                addOutput('timer', `ğŸ“Š ${e.data}`);
            });

            eventSource.addEventListener('end', function(e) {
                addOutput('timer', `\n${e.data}`);
            });

            eventSource.onerror = function(e) {
                updateStatus('timer', 'disconnected', 'âŒ è¿æ¥é”™è¯¯');
                addOutput('timer', '\nâŒ è¿æ¥å‡ºé”™æˆ–å·²å…³é—­');
                eventSource.close();
            };
        }

        // ç¤ºä¾‹4ï¼šJSON æ•°æ®
        function testJson() {
            stopConnection('json');
            updateStatus('json', 'connecting', 'æ­£åœ¨è¿æ¥...');
            addOutput('json', 'ğŸ”— å¼€å§‹å»ºç«‹è¿æ¥...');

            const eventSource = new EventSource('/api/learn/sse/json');
            connections['json'] = eventSource;

            eventSource.onopen = function() {
                updateStatus('json', 'connected', 'âœ… å·²è¿æ¥');
                addOutput('json', 'âœ… è¿æ¥æˆåŠŸï¼å¼€å§‹æ¥æ”¶ JSON æ•°æ®...\n');
            };

            eventSource.addEventListener('message', function(e) {
                try {
                    const json = JSON.parse(e.data);
                    addOutput('json', `ğŸ“¨ JSON: ${JSON.stringify(json, null, 2)}`);
                } catch (err) {
                    addOutput('json', `ğŸ“¨ ${e.data}`);
                }
            });

            eventSource.addEventListener('end', function(e) {
                try {
                    const json = JSON.parse(e.data);
                    addOutput('json', `\nâœ… ${JSON.stringify(json, null, 2)}`);
                } catch (err) {
                    addOutput('json', `\nâœ… ${e.data}`);
                }
            });

            eventSource.onerror = function(e) {
                updateStatus('json', 'disconnected', 'âŒ è¿æ¥é”™è¯¯');
                addOutput('json', '\nâŒ è¿æ¥å‡ºé”™æˆ–å·²å…³é—­');
                eventSource.close();
            };
        }

        // ç¤ºä¾‹5ï¼šæ¨¡æ‹ŸèŠå¤©
        function testChat() {
            stopConnection('chat');
            const question = document.getElementById('chat-question').value || 'ä½ å¥½';
            updateStatus('chat', 'connecting', 'æ­£åœ¨è¿æ¥...');
            addOutput('chat', 'ğŸ”— å¼€å§‹å»ºç«‹è¿æ¥...');

            const eventSource = new EventSource(`/api/learn/sse/chat?question=${encodeURIComponent(question)}`);
            connections['chat'] = eventSource;

            eventSource.onopen = function() {
                updateStatus('chat', 'connected', 'âœ… å·²è¿æ¥');
                addOutput('chat', `âœ… è¿æ¥æˆåŠŸï¼\nğŸ‘¤ ä½ çš„é—®é¢˜ï¼š${question}\nğŸ¤– AI å›ç­”ï¼š\n`);
            };

            eventSource.addEventListener('chunk', function(e) {
                // è¿½åŠ å­—ç¬¦ï¼Œä¸æ¢è¡Œï¼ˆæ¨¡æ‹Ÿæ‰“å­—æ•ˆæœï¼‰
                const outputEl = document.getElementById('output-chat');
                outputEl.textContent += e.data;
                outputEl.scrollTop = outputEl.scrollHeight;
            });

            eventSource.addEventListener('end', function(e) {
                addOutput('chat', `\n\n${e.data}`);
            });

            eventSource.onerror = function(e) {
                updateStatus('chat', 'disconnected', 'âŒ è¿æ¥é”™è¯¯');
                addOutput('chat', '\n\nâŒ è¿æ¥å‡ºé”™æˆ–å·²å…³é—­');
                eventSource.close();
            };
        }

        // é¡µé¢å¸è½½æ—¶å…³é—­æ‰€æœ‰è¿æ¥
        window.addEventListener('beforeunload', function() {
            for (let type in connections) {
                connections[type].close();
            }
        });
    </script>
</body>
</html>

